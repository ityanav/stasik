<!DOCTYPE html>
<html lang="ru"><head>
<meta charset="utf-8">
<title>Stasik Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2/dist/chartjs-plugin-datalabels.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0C0E18;--bg2:#13151F;--bg3:#1A1C28;--bg-hover:#1F2133;
  --text:#E8E9ED;--text-secondary:#8B8D97;--muted:#5A5C66;
  --border:rgba(255,255,255,0.06);--border-hover:rgba(255,255,255,0.12);
  --green:#22C55E;--red:#EF4444;--accent:#3B82F6;--amber:#F59E0B;
  --c-fiba:#8B5CF6;--c-buba:#6366F1;--c-tbank:#22C55E;
  --c-tbank-swing:#06B6D4;--c-midas:#F59E0B;--c-scalp:#3B82F6;
  --c-degen:#EC4899;--c-swing:#F97316;--c-turtle:#10B981;
  --shadow-card:0 1px 3px rgba(0,0,0,0.3),0 4px 12px rgba(0,0,0,0.15);
  --shadow-elevated:0 4px 24px rgba(0,0,0,0.4);
  --radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:20px;
  --radius-pill:9999px;
  --glass-bg:rgba(19,21,31,0.8);--glass-blur:blur(12px);
}
*{box-sizing:border-box;margin:0;padding:0}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--accent)}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}

.header{
  background:var(--glass-bg);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);
  border-bottom:1px solid var(--border);
  padding:12px 24px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;gap:16px;flex-wrap:wrap;
}
.header-left{display:flex;align-items:center;gap:12px;flex-shrink:0}
.header h1{font-size:20px;font-weight:700;color:var(--text);white-space:nowrap}
.header h1 span{color:var(--text-secondary);font-weight:400}
.header-stats{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px;border-left:1px solid var(--border);padding-left:12px;white-space:nowrap}
.header-stats .hs-val{color:var(--text);font-weight:600}
.header-stats .hs-sep{color:var(--muted);margin:0 4px}
.header-center{display:flex;align-items:center;gap:10px;flex-wrap:wrap;font-size:13px}
.header-center .msk-clock{font-weight:700;color:var(--text);font-size:14px;font-variant-numeric:tabular-nums}
.hsep{color:var(--muted)}
.hmarket{display:flex;align-items:center;gap:5px}
.hm-label{color:var(--muted);font-size:12px}
.sessions-bar{
  display:flex;gap:12px;align-items:center;margin-top:4px;flex-wrap:wrap;
}
.session-item{
  display:flex;align-items:center;gap:4px;font-size:11px;
  padding:3px 8px;border-radius:6px;background:var(--bg3);border:1px solid var(--border);
  font-variant-numeric:tabular-nums;
}
.session-item .sess-flag{font-size:13px}
.session-item .sess-name{color:var(--muted);font-weight:500}
.session-item .sess-time{color:var(--text);font-weight:600}
.session-item .sess-msk{color:var(--text-secondary);font-size:10px}
.session-item.active{border-color:var(--green);background:rgba(34,197,94,0.06)}
.session-item.active .sess-name{color:var(--green)}
.header-right{display:flex;align-items:center;gap:16px;flex-shrink:0}
#status-badge{
  padding:5px 14px;border-radius:20px;font-size:12px;font-weight:600;letter-spacing:0.5px;
}
#status-badge.on{background:rgba(34,197,94,0.1);color:var(--green);border:1px solid rgba(34,197,94,0.2)}
#status-badge.off{background:rgba(239,68,68,0.08);color:var(--red);border:1px solid rgba(239,68,68,0.2)}
.logout-btn{
  background:var(--bg3);border:1px solid var(--border);
  color:var(--muted);padding:6px 16px;border-radius:10px;font-size:13px;font-family:inherit;
  text-decoration:none;transition:all 0.2s;
}
.logout-btn:hover{background:rgba(239,68,68,0.08);color:var(--red);border-color:rgba(239,68,68,0.2)}

.container{max-width:1200px;margin:0 auto;padding:24px}

.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:14px;margin-bottom:24px}
.card{
  background:var(--glass-bg);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);
  border:1px solid var(--border);border-radius:var(--radius-md);
  padding:20px;transition:transform 0.2s,box-shadow 0.2s,border-color 0.2s;position:relative;overflow:hidden;
  box-shadow:var(--shadow-card);
}
.card:hover{transform:translateY(-1px);border-color:var(--border-hover)}
.card .card-icon{font-size:24px;margin-bottom:8px;display:block}
.card h3{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1.2px}
.card .val{font-size:26px;font-weight:700;margin-top:6px;transition:all 0.3s;font-variant-numeric:tabular-nums}
.g{color:var(--green)}.r{color:var(--red)}

.chart-section{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-md);
  padding:24px;margin-top:32px;margin-bottom:24px;
}
.chart-section h2{font-size:16px;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:8px}

.section{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-md);
  padding:20px;margin-bottom:24px;
}
.section h2{font-size:16px;color:var(--text);margin-bottom:14px;display:flex;align-items:center;gap:8px}

table{width:100%;border-collapse:collapse}
th{text-align:left;padding:10px 12px;color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:1px;border-bottom:2px solid var(--border)}
td{padding:10px 12px;font-size:13px;border-bottom:1px solid var(--border)}
tr{transition:background 0.2s}
tr:hover{background:rgba(255,255,255,0.02)}
.side-long{color:var(--green);font-weight:600}
.side-short{color:var(--red);font-weight:600}
.status-closed{color:var(--muted)}
.status-open{color:var(--accent);font-weight:600}
.inst-tag{font-size:10px;padding:2px 8px;border-radius:8px;font-weight:600;letter-spacing:0.5px}
.inst-scalp{background:rgba(59,130,246,0.1);color:var(--c-scalp)}
.inst-swing{background:rgba(249,115,22,0.1);color:var(--c-swing)}
.inst-degen{background:rgba(236,72,153,0.1);color:var(--c-degen)}
.inst-tbank{background:rgba(34,197,94,0.1);color:var(--c-tbank)}
.inst-midas{background:rgba(245,158,11,0.1);color:var(--c-midas)}
.inst-turtle{background:rgba(16,185,129,0.1);color:var(--c-turtle)}
.inst-fiba{background:rgba(139,92,246,0.1);color:var(--c-fiba)}
.inst-buba{background:rgba(99,102,241,0.1);color:var(--c-buba)}
.so-badge{font-size:9px;padding:1px 5px;border-radius:6px;font-weight:700;background:rgba(245,158,11,0.12);color:var(--amber);border:1px solid rgba(245,158,11,0.3);margin-left:4px;vertical-align:middle}
.tbl-wrap{overflow-x:auto}

.pagination{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:14px}
.pagination button{
  background:var(--bg3);border:1px solid var(--border);
  color:var(--text-secondary);padding:8px 18px;border-radius:8px;font-size:13px;font-family:inherit;
  cursor:pointer;transition:all 0.2s;
}
.pagination button:hover{background:var(--bg-hover);border-color:var(--border-hover)}
.pagination button:disabled{opacity:0.3;cursor:not-allowed}
.pagination .page-info{color:var(--muted);font-size:13px}

.instances{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px;margin-bottom:20px;
}
.instance-card{
  background:var(--glass-bg);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);
  border:1px solid var(--border);border-radius:var(--radius-md);
  padding:20px;position:relative;overflow:hidden;transition:border-color 0.2s,box-shadow 0.2s;
  box-shadow:var(--shadow-card);
}
.instance-card:hover{border-color:var(--border-hover)}
.instance-card.scalp{border-left:4px solid var(--c-scalp)}
.instance-card.swing{border-left:4px solid var(--c-swing)}
.instance-card.degen{border-left:4px solid var(--c-degen)}
.instance-card.tbank{border-left:4px solid var(--c-tbank)}
.instance-card.midas{border-left:4px solid var(--c-midas)}
.instance-card.turtle{border-left:4px solid var(--c-turtle)}
.instance-card.smc{border-left:4px solid var(--c-fiba)}
.instance-card.buba{border-left:4px solid var(--c-buba)}
.instance-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.instance-name{font-size:18px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px;flex:1;min-width:0}
.instance-name .badge{
  font-size:10px;padding:3px 10px;border-radius:12px;font-weight:600;letter-spacing:0.5px;
}
.badge-scalp{background:rgba(59,130,246,0.1);color:var(--c-scalp);border:1px solid rgba(59,130,246,0.2)}
.badge-swing{background:rgba(249,115,22,0.1);color:var(--c-swing);border:1px solid rgba(249,115,22,0.2)}
.badge-degen{background:rgba(236,72,153,0.1);color:var(--c-degen);border:1px solid rgba(236,72,153,0.2)}
.badge-tbank{background:rgba(34,197,94,0.1);color:var(--c-tbank);border:1px solid rgba(34,197,94,0.2)}
.badge-midas{background:rgba(245,158,11,0.1);color:var(--c-midas);border:1px solid rgba(245,158,11,0.2)}
.badge-turtle{background:rgba(16,185,129,0.1);color:var(--c-turtle);border:1px solid rgba(16,185,129,0.2)}
.badge-smc{background:rgba(139,92,246,0.1);color:var(--c-fiba);border:1px solid rgba(139,92,246,0.2)}
.badge-buba{background:rgba(99,102,241,0.1);color:var(--c-buba);border:1px solid rgba(99,102,241,0.2)}
.instance-status{font-size:12px;font-weight:600;padding:4px 12px;border-radius:12px}
.instance-status.on{background:rgba(34,197,94,0.1);color:var(--green)}
.instance-status.off{background:rgba(239,68,68,0.08);color:var(--red)}
.instance-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.instance-stat h4{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.instance-stat .val{font-size:20px;font-weight:700;font-variant-numeric:tabular-nums}
.instance-meta{margin-top:12px;font-size:11px;color:var(--muted);display:flex;gap:14px;flex-wrap:wrap;align-items:center}
.instance-pairs{margin-top:8px;display:flex;gap:4px;flex-wrap:wrap}
.pair-tag{font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.04);border:1px solid var(--border);color:var(--text-secondary);font-family:inherit;letter-spacing:0.5px}
.lev-select{
  background:var(--bg3);border:1px solid var(--border);border-radius:6px;
  padding:2px 6px;font-size:11px;font-weight:600;color:var(--text);font-family:inherit;
  cursor:pointer;outline:none;min-width:52px;
}
.lev-select:hover{border-color:var(--border-hover)}
.lev-select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,0.15)}
.lev-select:disabled{opacity:0.5;cursor:not-allowed}

@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn 0.2s ease}
.tf-buttons{display:flex;gap:4px}
.tf-buttons button{
  background:var(--bg3);border:1px solid var(--border);
  color:var(--muted);padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;font-family:inherit;
  cursor:pointer;transition:all 0.2s;
}
.tf-buttons button:hover{background:var(--bg-hover)}
.tf-buttons button.active{background:var(--accent);border-color:var(--accent);color:#fff}

.date-nav{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.date-nav button{
  background:var(--bg3);border:1px solid var(--border);
  color:var(--muted);padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600;font-family:inherit;
  cursor:pointer;transition:all 0.2s;
}
.date-nav button:hover{background:var(--bg-hover)}
.date-nav button.active{background:var(--accent);border-color:var(--accent);color:#fff}
.date-nav .date-label{font-size:13px;font-weight:700;color:var(--text);min-width:90px;text-align:center}
.date-nav .date-badge{
  background:rgba(245,158,11,0.1);color:var(--amber);padding:3px 10px;border-radius:12px;
  font-size:11px;font-weight:700;display:none;
}

.chart-half{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px;position:relative}
.chart-half-label{font-size:12px;font-weight:600;color:var(--muted);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.dot-bybit{background:var(--accent)}
.dot-degen{background:var(--c-degen)}
.dot-tbank{background:var(--c-tbank)}
.dot-swing{background:var(--c-swing)}
.dot-midas{background:var(--c-midas)}
.dot-turtle{background:var(--c-turtle)}
.dot-fiba{background:var(--c-fiba)}
.chart-legend-custom{display:flex;gap:12px;font-size:12px;color:var(--muted)}
.chart-legend-custom .leg-item{display:flex;align-items:center;gap:5px}
.leg-bar{width:12px;height:10px;border-radius:2px}
.leg-line{width:14px;height:2px;border-radius:1px}

.chart-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));
  gap:14px;margin-top:16px;
}
.chart-mini{
  background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-md);
  padding:14px;position:relative;
}
.chart-mini-header{
  display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;
}
.expand-btn{
  background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);
  color:var(--accent);width:28px;height:28px;border-radius:6px;
  cursor:pointer;font-size:14px;transition:all 0.2s;
}
.expand-btn:hover{background:rgba(59,130,246,0.15)}
.chart-fullscreen-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:1000;
  display:flex;align-items:center;justify-content:center;padding:24px;
}
.chart-fullscreen-content{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;
  width:95vw;max-height:90vh;position:relative;
}
.close-btn{
  position:absolute;top:12px;right:12px;
  background:var(--bg3);border:1px solid var(--border);
  width:32px;height:32px;border-radius:8px;
  cursor:pointer;font-size:16px;color:var(--muted);
}

.source-toggle{display:flex;gap:0;border-radius:20px;overflow:hidden;border:1px solid var(--border)}
.source-toggle button{
  background:var(--bg3);border:none;color:var(--muted);padding:6px 16px;
  font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:inherit;
}
.source-toggle button:hover{background:var(--bg-hover)}
.source-toggle button.active{background:var(--accent);color:#fff}
.source-toggle button.archive-active{background:var(--amber);color:var(--bg)}
.archive-banner{
  background:rgba(245,158,11,0.08);
  border:1px solid rgba(245,158,11,0.2);border-radius:10px;
  padding:10px 20px;margin-bottom:16px;text-align:center;
  color:var(--amber);font-size:14px;font-weight:600;
}
body.archive-mode .header{border-bottom-color:rgba(245,158,11,0.2)}

.btn-icon{
  width:32px;height:32px;border-radius:8px;
  font-size:14px;cursor:pointer;transition:all 0.2s;
  border:1px solid;display:flex;align-items:center;justify-content:center;
}
.btn-icon-stop{background:rgba(239,68,68,0.08);border-color:rgba(239,68,68,0.2);color:var(--red)}
.btn-icon-stop:hover{background:rgba(239,68,68,0.15)}
.btn-icon-play{background:rgba(34,197,94,0.08);border-color:rgba(34,197,94,0.2);color:var(--green)}
.btn-icon-play:hover{background:rgba(34,197,94,0.15)}
.btn-icon-restart{background:rgba(59,130,246,0.08);border-color:rgba(59,130,246,0.2);color:var(--accent)}
.btn-icon-restart:hover{background:rgba(59,130,246,0.15)}

.bulk-actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.btn-bulk{
  padding:8px 20px;border-radius:10px;font-size:13px;font-weight:600;
  cursor:pointer;transition:all 0.2s;border:1px solid;font-family:inherit;
}
.btn-bulk:disabled{opacity:0.4;cursor:not-allowed}
.btn-bulk-restart{background:rgba(59,130,246,0.08);border-color:rgba(59,130,246,0.2);color:var(--accent)}
.btn-bulk-restart:hover{background:rgba(59,130,246,0.15)}
.btn-bulk-stop{background:rgba(239,68,68,0.08);border-color:rgba(239,68,68,0.2);color:var(--red)}
.btn-bulk-stop:hover{background:rgba(239,68,68,0.15)}
.btn-bulk-nolev{background:rgba(59,130,246,0.08);border-color:rgba(59,130,246,0.2);color:var(--accent)}
.btn-bulk-nolev:hover{background:rgba(59,130,246,0.15)}
.btn-icon:disabled{opacity:0.4;cursor:not-allowed}

.btn-close-x{
  background:none;border:none;color:var(--red);font-size:20px;font-weight:700;
  cursor:pointer;transition:all 0.2s;line-height:1;padding:2px 6px;border-radius:50%;
  opacity:0.5;
}
.btn-close-x:hover{opacity:1;background:rgba(239,68,68,0.12)}
.btn-close-x:disabled{opacity:0.2;cursor:not-allowed}
.btn-x2:disabled{opacity:0.4;cursor:not-allowed}
.sl-wrap{display:inline-flex;align-items:center;gap:4px}
.sl-input{width:60px;padding:3px 6px;border:1px solid rgba(239,68,68,0.2);border-radius:6px;font-size:12px;text-align:right;background:rgba(239,68,68,0.04);color:var(--text);font-family:inherit;-moz-appearance:textfield}
.sl-input::-webkit-outer-spin-button,.sl-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
.sl-input:focus{outline:none;border-color:var(--red)}
.btn-sl{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);color:var(--red);padding:3px 8px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;font-family:inherit}
.btn-sl:hover{background:rgba(239,68,68,0.15)}
.btn-sl:disabled{opacity:0.4;cursor:not-allowed}
.tp-wrap{display:inline-flex;align-items:center;gap:4px}
.tp-input{width:60px;padding:3px 6px;border:1px solid rgba(34,197,94,0.2);border-radius:6px;font-size:12px;text-align:right;background:rgba(34,197,94,0.04);color:var(--text);font-family:inherit;-moz-appearance:textfield}
.tp-input::-webkit-outer-spin-button,.tp-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
.tp-input:focus{outline:none;border-color:var(--green)}
.btn-tp{background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);color:var(--green);padding:3px 8px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;font-family:inherit}
.btn-tp:hover{background:rgba(34,197,94,0.15)}
.btn-tp:disabled{opacity:0.4;cursor:not-allowed}
.btn-close-all{
  background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);
  color:var(--red);padding:10px 24px;border-radius:10px;font-size:14px;font-weight:600;
  cursor:pointer;transition:all 0.2s;font-family:inherit;
}
.btn-close-all:hover{background:rgba(239,68,68,0.15)}
.btn-close-all:disabled{opacity:0.4;cursor:not-allowed}

.market-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.market-dot.open{background:var(--green)}
.market-dot.closed{background:var(--red)}
.market-status{font-weight:600;font-size:12px}
.market-status.open{color:var(--green)}
.market-status.closed{color:var(--red)}
.market-hours{color:var(--muted);font-size:11px}
.market-bal{font-weight:700;font-size:13px;color:var(--accent);background:var(--bg3);padding:2px 8px;border-radius:6px;font-variant-numeric:tabular-nums}
.today-pnl{font-weight:700;font-size:12px;padding:2px 6px;border-radius:6px;font-variant-numeric:tabular-nums}

.summary-bar{
  background:var(--glass-bg);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);
  border:1px solid var(--border);border-radius:var(--radius-md);
  padding:18px 24px;margin-bottom:20px;display:flex;align-items:center;gap:20px;
  flex-wrap:wrap;
}
.summary-main{text-align:center;min-width:140px}
.summary-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:4px}
.summary-value{font-size:32px;font-weight:800;font-variant-numeric:tabular-nums}
.summary-divider{width:1px;height:48px;background:var(--border);flex-shrink:0}
.summary-details{display:flex;flex-direction:column;gap:6px}
.summary-item{display:flex;align-items:center;gap:8px}
.summary-item-label{font-size:11px;color:var(--muted);min-width:56px}
.summary-item-val{font-size:15px;font-weight:700;font-variant-numeric:tabular-nums}
.pair-pnl-bar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px}
.pair-chip{display:flex;align-items:center;gap:6px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:12px}
.pair-chip-symbol{color:var(--muted);font-weight:600}
.pair-chip-cnt{color:var(--muted);font-size:10px}
.pair-chip-pnl{font-weight:800;font-variant-numeric:tabular-nums}
@media(max-width:600px){
  .summary-bar{padding:14px 16px;gap:14px}
  .summary-value{font-size:24px}
  .summary-divider{width:100%;height:1px}
}
.last-update{text-align:center;color:var(--muted);font-size:11px;padding:16px}

@media(max-width:600px){
  .container{padding:14px}
  .cards{grid-template-columns:repeat(2,1fr);gap:10px}
  .card{padding:14px}
  .card .val{font-size:20px}
  .header{padding:12px 16px;flex-wrap:wrap;gap:10px}
  .header h1{font-size:16px}
  .chart-grid{grid-template-columns:1fr}
  .chart-fullscreen-content{width:100vw;padding:16px;border-radius:var(--radius-md)}
}
.night-mode-wrap{display:flex;align-items:center;gap:8px}
.night-label{font-size:11px;color:var(--amber);font-weight:700;letter-spacing:1px}
.night-input{width:52px;padding:4px 6px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:6px;color:var(--amber);font-family:inherit;font-size:13px;text-align:center;outline:none;transition:border-color .2s}
.night-input:focus{border-color:var(--amber)}
.night-input::placeholder{color:rgba(245,158,11,0.3);font-size:11px}
.night-switch{position:relative;display:inline-block;width:36px;height:20px;flex-shrink:0}
.night-switch input{opacity:0;width:0;height:0}
.night-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:20px;transition:.3s}
.night-slider:before{content:'';position:absolute;height:14px;width:14px;left:2px;bottom:2px;background:#555;border-radius:50%;transition:.3s}
.night-switch input:checked+.night-slider{background:rgba(245,158,11,0.15);border-color:var(--amber)}
.night-switch input:checked+.night-slider:before{transform:translateX(16px);background:var(--amber)}
.sale-mode-wrap{display:flex;align-items:center;gap:8px}
.sale-label{font-size:11px;color:var(--accent);font-weight:700;letter-spacing:1px}
.sale-input{width:52px;padding:4px 6px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:6px;color:var(--accent);font-family:inherit;font-size:13px;text-align:center;outline:none;transition:border-color .2s}
.sale-input:focus{border-color:var(--accent)}
.sale-input::placeholder{color:rgba(59,130,246,0.3);font-size:11px}
.sale-switch{position:relative;display:inline-block;width:36px;height:20px;flex-shrink:0}
.sale-switch input{opacity:0;width:0;height:0}
.sale-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:20px;transition:.3s}
.sale-slider:before{content:'';position:absolute;height:14px;width:14px;left:2px;bottom:2px;background:#555;border-radius:50%;transition:.3s}
.sale-switch input:checked+.sale-slider{background:rgba(59,130,246,0.15);border-color:var(--accent)}
.sale-switch input:checked+.sale-slider:before{transform:translateX(16px);background:var(--accent)}

@supports not (backdrop-filter:blur(1px)){
  .header,.card,.instance-card,.summary-bar{background:var(--bg2)}
}

/* ‚îÄ‚îÄ Market Monitor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.market-section{margin-bottom:20px}
.market-section h3{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1.2px;margin:0 0 8px 4px}
.market-grid{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scrollbar-width:thin}
.market-grid::-webkit-scrollbar{height:4px}
.market-grid::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:2px}
.mk-card{
  background:var(--glass-bg);backdrop-filter:var(--glass-blur);
  border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:8px 12px;min-width:110px;flex-shrink:0;
  display:flex;align-items:center;gap:8px;
  transition:border-color 0.2s;
}
.mk-card:hover{border-color:var(--border-hover)}
.mk-card.fib-active{border-color:var(--accent);box-shadow:0 0 8px rgba(34,197,94,0.15)}
.mk-arrow{font-size:16px;line-height:1}
.mk-sym{font-size:12px;font-weight:700;color:var(--text);min-width:36px}
.mk-dev{font-size:12px;font-weight:700;font-variant-numeric:tabular-nums;min-width:50px;text-align:right}
.mk-fib{font-size:10px;color:var(--muted);min-width:42px;text-align:right}
.mk-fib.active{color:var(--accent);font-weight:700}
</style>
</head><body>

<div class="header">
  <div class="header-left">
    <span style="font-size:24px;font-weight:800;color:var(--accent);letter-spacing:-1px">S</span>
    <h1>Stasik <span>Trading Bot</span></h1>
    <div class="header-stats" id="header-stats"></div>
  </div>
  <div class="header-center">
    <span class="msk-clock" id="msk-clock">--:--:--</span>
    <span class="hsep">|</span>
    <div class="hmarket">
      <span class="market-dot" id="bybit-dot"></span>
      <span class="hm-label">Bybit</span>
      <span class="market-status open">24/7</span>
      <span class="market-hours" id="bybit-hours"></span>
      <span class="market-bal" id="bybit-bal">‚Äî</span>
      <span class="today-pnl" id="bybit-pnl"></span>
    </div>
    <span class="hsep">|</span>
    <div class="hmarket">
      <span class="market-dot" id="moex-dot"></span>
      <span class="hm-label">MOEX</span>
      <span class="market-status" id="moex-status">‚Äî</span>
      <span class="market-hours" id="moex-hours"></span>
      <span class="market-bal" id="tbank-bal">‚Äî</span>
      <span class="today-pnl" id="tbank-pnl"></span>
    </div>
    <span class="hsep">|</span>
    <div class="sessions-bar" id="sessions-bar">
      <div class="session-item" id="sess-asia">
        <span class="sess-flag">üåè</span>
        <span class="sess-name">Asia</span>
        <span class="sess-time" id="sess-asia-time">--:--</span>
        <span class="sess-msk" id="sess-asia-msk"></span>
      </div>
      <div class="session-item" id="sess-london">
        <span class="sess-flag">üá¨üáß</span>
        <span class="sess-name">London</span>
        <span class="sess-time" id="sess-london-time">--:--</span>
        <span class="sess-msk" id="sess-london-msk"></span>
      </div>
      <div class="session-item" id="sess-ny">
        <span class="sess-flag">üá∫üá∏</span>
        <span class="sess-name">NY</span>
        <span class="sess-time" id="sess-ny-time">--:--</span>
        <span class="sess-msk" id="sess-ny-msk"></span>
      </div>
    </div>
  </div>
  <div class="header-right">
    <div class="night-mode-wrap" id="night-mode-wrap">
      <span class="night-label">NIGHT</span>
      <input type="text" class="night-input" id="night-target" maxlength="4" inputmode="numeric" placeholder="PnL">
      <label class="night-switch"><input type="checkbox" id="night-toggle"><span class="night-slider"></span></label>
    </div>
    <div class="sale-mode-wrap" id="sale-mode-wrap">
      <span class="sale-label">SALE</span>
      <input type="text" class="sale-input" id="sale-target" maxlength="4" inputmode="numeric" placeholder="PnL">
      <label class="sale-switch"><input type="checkbox" id="sale-toggle"><span class="sale-slider"></span></label>
    </div>
    <div class="source-toggle" id="source-toggle">
      <button class="active" onclick="setSource('live')" data-source="live">Live</button>
      <button onclick="setSource('archive')" data-source="archive">–ê—Ä—Ö–∏–≤</button>
    </div>
    <div id="status-badge" class="off">...</div>
    <a href="/logout" class="logout-btn">–í—ã—Ö–æ–¥</a>
  </div>
</div>

<div class="container">
  <div class="archive-banner" id="archive-banner" style="display:none">–ê–†–•–ò–í ‚Äî –¥–∞–Ω–Ω—ã–µ –¥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ö–æ—Ç–µ–≥–∞–≤—ã</div>

  <div class="summary-bar" id="summary-bar">
    <div class="summary-details">
      <div class="summary-item">
        <span class="summary-item-label">Bybit</span>
        <span class="summary-item-val" id="summary-bybit">‚Äî</span>
      </div>
      <div class="summary-item">
        <span class="summary-item-label">TBank</span>
        <span class="summary-item-val" id="summary-tbank">‚Äî</span>
      </div>
    </div>
    <div class="summary-divider"></div>
    <div class="summary-details">
      <div class="summary-item">
        <span class="summary-item-label">–°–¥–µ–ª–æ–∫</span>
        <span class="summary-item-val" id="summary-trades">0</span>
      </div>
      <div class="summary-item">
        <span class="summary-item-label">–ü–æ–∑–∏—Ü–∏–∏</span>
        <span class="summary-item-val" id="summary-positions">0</span>
      </div>
    </div>
    <div class="summary-divider"></div>
    <div class="summary-details">
      <div class="summary-item">
        <span class="summary-item-label">Win Rate</span>
        <span class="summary-item-val" id="summary-wr">‚Äî</span>
      </div>
      <div class="summary-item">
        <span class="summary-item-label">–í—Å–µ–≥–æ PnL</span>
        <span class="summary-item-val" id="summary-all">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- Market Monitor -->
  <div id="market-wrap">
    <div class="market-section">
      <h3>FIBA 15–º ‚Äî EMA —Ç—Ä–µ–Ω–¥ + Fib</h3>
      <div class="market-grid" id="market-fiba"></div>
    </div>
    <div class="market-section">
      <h3>BUBA 1H ‚Äî EMA —Ç—Ä–µ–Ω–¥ + Fib</h3>
      <div class="market-grid" id="market-buba"></div>
    </div>
  </div>

  <div class="pair-pnl-bar" id="pair-pnl-bar"></div>

  <div class="section">
    <h2>üìä –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏</h2>
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>Bot</th><th>Pair</th><th>Side</th><th>Lev</th><th>PS</th><th>TP</th><th>SL</th><th>Gross PnL</th><th>Fee</th><th>Net PnL</th><th></th></tr></thead>
        <tbody id="pos-body"></tbody>
      </table>
    </div>
    <div id="close-all-wrap" style="display:none;margin-top:14px;text-align:right">
      <button class="btn-close-all" onclick="closeAllPositions()">CLOSE ALL</button>
    </div>
  </div>

  <div class="section">
    <h2>üìã –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</h2>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>Bot</th><th>Pair</th><th>Side</th><th>Lev</th><th>Size</th><th>Entry</th><th>Exit</th><th>PS</th><th>Gross PnL</th><th>Net PnL</th><th>Time</th><th>Dur</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="pagination">
      <button id="prev-btn" disabled onclick="changePage(-1)">‚Üê –ù–∞–∑–∞–¥</button>
      <span class="page-info" id="page-info">–°—Ç—Ä. 1</span>
      <button id="next-btn" disabled onclick="changePage(1)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
    </div>
  </div>

  <div class="instances" id="instances"></div>
  <div class="bulk-actions" id="bulk-actions">
    <button class="btn-bulk btn-bulk-restart" onclick="bulkAction('restart')">&#8635; Restart All</button>
    <button class="btn-bulk btn-bulk-stop" onclick="bulkAction('stop')">&#9632; Kill All</button>
  </div>

  <div class="chart-section">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <h2 style="margin:0">üìà PnL</h2>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <div class="chart-legend-custom" id="chart-legend"></div>
        <div class="tf-buttons" id="tf-buttons">
          <button class="active" onclick="setTF('1m')" data-tf="1m">1–º</button>
          <button onclick="setTF('5m')" data-tf="5m">5–º</button>
          <button onclick="setTF('10m')" data-tf="10m">10–º</button>
          <button onclick="setTF('30m')" data-tf="30m">30–º</button>
          <button onclick="setTF('1H')" data-tf="1H">1—á</button>
          <button onclick="setTF('1D')" data-tf="1D">1–¥</button>
          <button onclick="setTF('1M')" data-tf="1M">1–º–µ—Å</button>
        </div>
      </div>
    </div>
    <!-- Date navigator (shown only in archive mode) -->
    <div class="date-nav" id="date-nav" style="display:none">
      <button onclick="navDate(-1)">&#8592; –ü—Ä–µ–¥</button>
      <span class="date-label" id="date-label">–°–µ–≥–æ–¥–Ω—è</span>
      <button onclick="navDate(1)">–°–ª–µ–¥ &#8594;</button>
      <button class="active" id="btn-today" onclick="setArchiveDate(null,'day')">–°–µ–≥–æ–¥–Ω—è</button>
      <button id="btn-week" onclick="toggleWeek()">–ù–µ–¥–µ–ª—è</button>
      <span class="date-badge" id="date-badge">–ê—Ä—Ö–∏–≤</span>
    </div>
    <!-- Combined chart: all instances -->
    <div class="chart-half">
      <div class="chart-half-label">–í—Å–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã ‚Äî –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π PnL</div>
      <canvas id="pnlChartCombined"></canvas>
    </div>

    <!-- Mini-charts grid -->
    <div class="chart-grid" id="chart-grid">
      <div class="chart-mini" id="mini-fiba">
        <div class="chart-mini-header">
          <span class="chart-half-label" style="margin:0"><span class="dot dot-fiba"></span>FIBA</span>
          <button class="expand-btn" onclick="expandChart('FIBA')">&#x2922;</button>
        </div>
        <canvas id="pnlChartFiba"></canvas>
      </div>
    </div>
  </div>

  <!-- Fullscreen overlay for expanded charts -->
  <div class="chart-fullscreen-overlay" id="chart-fullscreen" style="display:none" onclick="closeFullscreen(event)">
    <div class="chart-fullscreen-content" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeFullscreen()">&#x2715;</button>
      <div id="fullscreen-label" style="font-size:14px;font-weight:600;color:var(--muted);margin-bottom:12px"></div>
      <canvas id="pnlChartFull"></canvas>
    </div>
  </div>

  <div class="last-update" id="last-update"></div>
</div>

<script>
let currentPage=1,hasNext=false,currentTF='1m',currentSource='live';
let archiveDate=null; // null = today (live)
let archiveRange='day'; // 'day' | 'week'
let _nightEnabled=false,_nightTarget=0;
let _nightSaveTimer=null;
function _nightSave(){
  clearTimeout(_nightSaveTimer);
  _nightSaveTimer=setTimeout(()=>{
    fetch('/api/night-settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled:_nightEnabled,target:_nightTarget})});
  },300);
}
(function(){
  document.addEventListener('DOMContentLoaded',()=>{
    const inp=document.getElementById('night-target');
    const tog=document.getElementById('night-toggle');
    fetch('/api/night-settings').then(r=>r.json()).then(d=>{
      _nightEnabled=!!d.enabled;_nightTarget=d.target||0;
      tog.checked=_nightEnabled;
      if(_nightTarget)inp.value=_nightTarget;
    }).catch(()=>{});
    inp.addEventListener('input',()=>{
      inp.value=inp.value.replace(/[^0-9]/g,'').slice(0,4);
      _nightTarget=parseInt(inp.value)||0;
      _nightSave();
    });
    tog.addEventListener('change',()=>{
      _nightEnabled=tog.checked;
      _nightSave();
    });
  });
})();

let _saleEnabled=false,_saleTarget=0;
let _saleSaveTimer=null;
function _saleSave(){
  clearTimeout(_saleSaveTimer);
  _saleSaveTimer=setTimeout(()=>{
    fetch('/api/sale-settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled:_saleEnabled,target:_saleTarget})});
  },300);
}
(function(){
  document.addEventListener('DOMContentLoaded',()=>{
    const inp=document.getElementById('sale-target');
    const tog=document.getElementById('sale-toggle');
    fetch('/api/sale-settings').then(r=>r.json()).then(d=>{
      _saleEnabled=!!d.enabled;_saleTarget=d.target||0;
      tog.checked=_saleEnabled;
      if(_saleTarget)inp.value=_saleTarget;
    }).catch(()=>{});
    inp.addEventListener('input',()=>{
      inp.value=inp.value.replace(/[^0-9]/g,'').slice(0,4);
      _saleTarget=parseInt(inp.value)||0;
      _saleSave();
    });
    tog.addEventListener('change',()=>{
      _saleEnabled=tog.checked;
      _saleSave();
    });
  });
})();

function fmt(v){return(v>=0?'+':'')+v.toFixed(2)}
function cls(v){return v>=0?'g':'r'}

function fmtDateRu(d){
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  return dd+'.'+mm+'.'+d.getFullYear();
}
function toISO(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}

function updateDateNav(){
  const label=document.getElementById('date-label');
  const badge=document.getElementById('date-badge');
  const btnToday=document.getElementById('btn-today');
  const btnWeek=document.getElementById('btn-week');
  if(!archiveDate){
    label.textContent='–°–µ–≥–æ–¥–Ω—è';
    badge.style.display='none';
    btnToday.classList.add('active');
  }else{
    const d=new Date(archiveDate+'T00:00:00');
    if(archiveRange==='week'){
      const end=new Date(d);end.setDate(end.getDate()+6);
      label.textContent=fmtDateRu(d)+' ‚Äî '+fmtDateRu(end);
    }else{
      label.textContent=fmtDateRu(d);
    }
    badge.style.display='';
    btnToday.classList.remove('active');
  }
  btnWeek.classList.toggle('active',archiveRange==='week');
}

function setArchiveDate(dateStr,range){
  archiveDate=dateStr;
  archiveRange=range||'day';
  currentPage=1;
  updateDateNav();
  loadChart();
  loadTrades(1);
}

function navDate(dir){
  const step=archiveRange==='week'?7:1;
  let d;
  if(archiveDate){
    d=new Date(archiveDate+'T00:00:00');
  }else{
    d=new Date();d.setHours(0,0,0,0);
  }
  d.setDate(d.getDate()+dir*step);
  if(currentSource==='archive'){
    setArchiveDate(toISO(d),archiveRange);
  }else{
    const today=new Date();today.setHours(0,0,0,0);
    if(d>=today){
      setArchiveDate(null,archiveRange);
    }else{
      setArchiveDate(toISO(d),archiveRange);
    }
  }
}

function toggleWeek(){
  if(archiveRange==='week'){
    archiveRange='day';
  }else{
    archiveRange='week';
    // Align to Monday
    if(archiveDate){
      const d=new Date(archiveDate+'T00:00:00');
      const dow=d.getDay()||7;
      d.setDate(d.getDate()-(dow-1));
      archiveDate=toISO(d);
    }
  }
  currentPage=1;
  updateDateNav();
  loadChart();
  loadTrades(1);
}

function setTF(tf){
  currentTF=tf;
  document.querySelectorAll('.tf-buttons button').forEach(b=>b.classList.toggle('active',b.dataset.tf===tf));
  loadChart();
}
function setSource(src){
  currentSource=src;
  currentPage=1;
  archiveDate=null;archiveRange='day';updateDateNav();
  document.querySelectorAll('.source-toggle button').forEach(b=>{
    b.classList.remove('active','archive-active');
    if(b.dataset.source===src){b.classList.add(src==='archive'?'archive-active':'active')}
  });
  const banner=document.getElementById('archive-banner');
  const badge=document.getElementById('status-badge');
  const dateNav=document.getElementById('date-nav');
  const instances=document.getElementById('instances');
  const bulkActs=document.getElementById('bulk-actions');
  const marketWrap=document.getElementById('market-wrap');
  const nightWrap=document.getElementById('night-mode-wrap');
  const saleWrap=document.getElementById('sale-mode-wrap');
  if(src==='archive'){
    banner.style.display='';
    badge.style.display='none';
    dateNav.style.display='';
    instances.style.display='none';
    bulkActs.style.display='none';
    nightWrap.style.display='none';
    saleWrap.style.display='none';
    marketWrap.style.display='none';
    document.body.classList.add('archive-mode');
  }else{
    banner.style.display='none';
    badge.style.display='';
    dateNav.style.display='';
    instances.style.display='';
    bulkActs.style.display='';
    nightWrap.style.display='flex';
    saleWrap.style.display='flex';
    marketWrap.style.display='';
    document.body.classList.remove('archive-mode');
  }
  loadAll();
}

async function loadInstances(){
  try{
    const list=await(await fetch('/api/instances?source='+currentSource)).json();
    const el=document.getElementById('instances');
    el.innerHTML=list.map(i=>{
      const key=i.name.toUpperCase();
      const isTbank=key.includes('TBANK');
      const isDegen=key.includes('DEGEN');
      const isScalp=key.includes('SCALP')&&!isTbank;
      const isSwing=key.includes('SWING')&&!isTbank;
      const isMidas=key.includes('MIDAS');
      const isTurtle=key.includes('TURTLE')&&!isTbank;
      const isSmc=key.includes('FIBA');
      const isBuba=key.includes('BUBA');
      const cardCls=isTbank?'tbank':isDegen?'degen':isScalp?'scalp':isMidas?'midas':isTurtle?'turtle':isBuba?'buba':isSmc?'smc':'swing';
      const badgeCls=isTbank?'badge-tbank':isDegen?'badge-degen':isScalp?'badge-scalp':isMidas?'badge-midas':isTurtle?'badge-turtle':isBuba?'badge-buba':isSmc?'badge-smc':'badge-swing';
      const tf=i.timeframe;
      const cur=(isTbank||isMidas)?'RUB':'USDT';
      const icon=isTbank?'üè¶':isDegen?'üé∞':isScalp?'‚ö°':isMidas?'ü•á':isTurtle?'üê¢':isBuba?'üîÆ':isSmc?'üß†':'üåä';
      const svc=i.service||'';
      const toggleBtn=svc&&currentSource==='live'?
        (i.running?`<button class="btn-icon btn-icon-stop" onclick="toggleService('${svc}','stop',this)" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">&#9632;</button>`
                  :`<button class="btn-icon btn-icon-play" onclick="toggleService('${svc}','start',this)" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å">&#9654;</button>`):'';
      const restartBtn=svc&&currentSource==='live'?
        `<button class="btn-icon btn-icon-restart" onclick="toggleService('${svc}','restart',this)" title="–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å">&#8635;</button>`:'';
      return`<div class="instance-card ${cardCls} fade-in">
        <div class="instance-header">
          <div class="instance-name">
            ${icon}
            <span>${i.name}</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
            ${restartBtn}
            ${toggleBtn}
            <div class="instance-status ${i.running?'on':'off'}">${i.running?'–†–ê–ë–û–¢–ê–ï–¢':'–°–¢–û–ü'}</div>
          </div>
        </div>
        <div class="instance-stats">
          <div class="instance-stat"><h4>–ó–∞ –¥–µ–Ω—å</h4><div class="val ${cls(i.daily_pnl)}">${fmt(i.daily_pnl)} ${cur}</div></div>
          <div class="instance-stat"><h4>–í—Å–µ–≥–æ PnL</h4><div class="val ${cls(i.total_pnl)}">${fmt(i.total_pnl)} ${cur}</div></div>
          <div class="instance-stat"><h4>Win Rate</h4><div class="val">${i.total_trades?i.win_rate.toFixed(1)+'%':'‚Äî'}</div></div>
        </div>
        <div class="instance-meta">
          <span>üìä –ü–æ–∑–∏—Ü–∏–∏: ${i.open_positions}</span>
          <span>üî¢ –°–¥–µ–ª–æ–∫: ${i.total_trades} (${i.wins}W / ${i.losses}L)</span>
          <span>‚ö° ${i.leverage}x</span>
        </div>
        <div class="instance-pairs">${i.pairs.map(p=>`<span class="pair-tag">${p}</span>`).join('')}</div>
      </div>`;
    }).join('');
    // Summary widget
    let bybitDay=0,tbankDay=0,bybitAll=0,tbankAll=0,totalTrades=0,totalPos=0,totalWins=0,totalLosses=0;
    list.forEach(i=>{
      const nm=i.name.toUpperCase();
      const tb=nm.includes('TBANK')||nm.includes('MIDAS');
      if(tb){tbankDay+=i.daily_pnl;tbankAll+=i.total_pnl}
      else{bybitDay+=i.daily_pnl;bybitAll+=i.total_pnl}
      totalTrades+=i.total_trades;totalPos+=i.open_positions;
      totalWins+=i.wins;totalLosses+=i.losses;
    });
    document.getElementById('summary-bybit').className='summary-item-val '+(bybitDay>=0?'g':'r');
    document.getElementById('summary-bybit').textContent=(bybitDay>=0?'+':'')+bybitDay.toFixed(2)+' USDT';
    document.getElementById('summary-tbank').className='summary-item-val '+(tbankDay>=0?'g':'r');
    document.getElementById('summary-tbank').textContent=(tbankDay>=0?'+':'')+tbankDay.toFixed(2)+' RUB';
    document.getElementById('summary-trades').textContent=totalTrades;
    document.getElementById('summary-positions').textContent=totalPos;
    const wr=totalTrades>0?(totalWins/totalTrades*100).toFixed(1)+'%':'‚Äî';
    document.getElementById('summary-wr').textContent=wr;
    const allEl=document.getElementById('summary-all');
    let allParts=[];
    if(bybitAll!==0){const c=bybitAll>=0?'#22C55E':'#EF4444';allParts.push(`<span style="color:${c}">${bybitAll>0?'+':''}${bybitAll.toFixed(0)}$</span>`)}
    if(tbankAll!==0){const c=tbankAll>=0?'#22C55E':'#EF4444';allParts.push(`<span style="color:${c}">${tbankAll>0?'+':''}${tbankAll.toFixed(0)}\u20bd</span>`)}
    allEl.innerHTML=allParts.length?allParts.join(' / '):'0';
  }catch(e){console.error('instances',e)}
}

async function loadMarket(){
  if(currentSource==='archive'){
    document.getElementById('market-wrap').style.display='none';return;
  }
  document.getElementById('market-wrap').style.display='';
  try{
    const d=await(await fetch('/api/market')).json();
    renderMarketGrid('market-fiba',d.fiba||[]);
    renderMarketGrid('market-buba',d.buba||[]);
  }catch(e){console.error('market',e)}
}
function renderMarketGrid(id,items){
  const el=document.getElementById(id);
  el.innerHTML=items.map(t=>{
    const arrow=t.bullish?'‚ÜóÔ∏è':'‚ÜòÔ∏è';
    const col=t.bullish?'#22C55E':'#EF4444';
    const sign=t.dev>=0?'+':'';
    const fibClass=t.in_fib?'active':'';
    const fibText=t.in_fib?'üéØ FIB':t.fib_dist!=null?'~'+t.fib_dist+'%':'';
    const cardClass=t.in_fib?'mk-card fib-active':'mk-card';
    return`<div class="${cardClass}"><span class="mk-arrow">${arrow}</span><span class="mk-sym">${t.symbol}</span><span class="mk-dev" style="color:${col}">${sign}${t.dev}%</span><span class="mk-fib ${fibClass}">${fibText}</span></div>`;
  }).join('');
}

async function loadPairPnl(){
  try{
    const pairs=await(await fetch('/api/pair-pnl?source='+currentSource)).json();
    const el=document.getElementById('pair-pnl-bar');
    el.innerHTML=pairs.map(p=>{
      const c=p.pnl>=0?'#22C55E':'#EF4444';
      const sign=p.pnl>0?'+':'';
      const val=p.cur==='USDT'?`${sign}${p.pnl.toFixed(2)}$`:`${sign}${p.pnl.toFixed(0)}\u20bd`;
      return`<div class="pair-chip"><span class="pair-chip-symbol">${p.symbol}</span><span class="pair-chip-cnt">${p.trades}</span><span class="pair-chip-pnl" style="color:${c}">${val}</span></div>`;
    }).join('');
  }catch(e){console.error('pair-pnl',e)}
}

async function loadStats(){
  try{
    const s=await(await fetch('/api/stats?source='+currentSource)).json();
    const b=document.getElementById('status-badge');
    b.className=s.running?'on':'off';
    b.textContent=s.running?'–†–ê–ë–û–¢–ê–ï–¢':'–û–°–¢–ê–ù–û–í–õ–ï–ù';
    const tb=s.tbank_balance||0;
    const hs=document.getElementById('header-stats');
    hs.innerHTML=`—Å–¥–µ–ª–æ–∫: <span class="hs-val">${s.all_trades||s.total_trades}</span>`;
    // Balance widgets in market bar
    const bybitBal=document.getElementById('bybit-bal');
    const tbankBal=document.getElementById('tbank-bal');
    bybitBal.textContent=s.balance?s.balance.toLocaleString('ru-RU',{maximumFractionDigits:0})+' USDT':'‚Äî';
    tbankBal.textContent=tb?tb.toLocaleString('ru-RU',{maximumFractionDigits:0})+' RUB':'‚Äî';
    // Today's net PnL
    const bPnl=s.today_pnl_usdt||0;const tPnl=s.today_pnl_rub||0;
    const bpEl=document.getElementById('bybit-pnl');
    const tpEl=document.getElementById('tbank-pnl');
    if(bPnl!==0){bpEl.textContent=(bPnl>0?'+':'')+bPnl.toFixed(2)+'$';bpEl.style.color=bPnl>=0?'#22C55E':'#EF4444'}else{bpEl.textContent=''}
    if(tPnl!==0){tpEl.textContent=(tPnl>0?'+':'')+tPnl.toFixed(0)+'\u20bd';tpEl.style.color=tPnl>=0?'#22C55E':'#EF4444'}else{tpEl.textContent=''}
  }catch(e){console.error('stats',e)}
}

let chartCombined=null, miniCharts={}, chartFull=null, instanceData={};
const INST_COLORS={FIBA:'#8B5CF6','TBANK-SCALP':'#22C55E','TBANK-SWING':'#06B6D4',MIDAS:'#F59E0B'};
const INST_CANVAS={FIBA:'pnlChartFiba'};
const INST_MINI={FIBA:'mini-fiba'};
const INST_CURRENCY={FIBA:'USDT','TBANK-SCALP':'RUB','TBANK-SWING':'RUB',MIDAS:'RUB'};
const INST_SYM={FIBA:'$','TBANK-SCALP':'\u20bd','TBANK-SWING':'\u20bd',MIDAS:'\u20bd'};

function buildArea(canvasId, labels, dailyArr, lineColor, currency, sym){
  const ctx=document.getElementById(canvasId).getContext('2d');

  // Cumulative PnL
  const cumulative=[];
  let cum=0;
  dailyArr.forEach(v=>{cum+=v;cumulative.push(cum)});

  // Y range: ¬±100% from peak |cumPnL| (symmetric around 0)
  const peak=Math.max(1,Math.max(...cumulative.map(Math.abs)));
  const yMax=Math.ceil(peak*2);const yMin=-yMax;

  // Pad x-axis +20% with empty space
  const extra=Math.max(1,Math.ceil(labels.length*0.2));
  const padLabels=[...labels];const padCum=[...cumulative];const padDaily=[...dailyArr];
  for(let i=0;i<extra;i++){padLabels.push('');padCum.push(null);padDaily.push(0)}

  // Plugin: fill green above 0, red below 0
  const zeroFillPlugin={
    id:'zeroFill',
    beforeDatasetsDraw(chart){
      const meta=chart.getDatasetMeta(0);
      if(!meta.data.length)return;
      const {ctx:c,chartArea:{left,right,bottom},scales:{y}}=chart;
      const zeroY=y.getPixelForValue(0);
      c.save();
      // Green region (above zero) ‚Äî clip to above zero line
      c.beginPath();
      c.rect(left,chart.chartArea.top,right-left,zeroY-chart.chartArea.top);
      c.clip();
      c.beginPath();
      c.moveTo(meta.data[0].x,zeroY);
      meta.data.forEach(pt=>c.lineTo(pt.x,pt.y));
      c.lineTo(meta.data[meta.data.length-1].x,zeroY);
      c.closePath();
      const gGreen=c.createLinearGradient(0,chart.chartArea.top,0,zeroY);
      gGreen.addColorStop(0,'rgba(34,197,94,0.25)');
      gGreen.addColorStop(1,'rgba(34,197,94,0.03)');
      c.fillStyle=gGreen;c.fill();
      c.restore();
      // Red region (below zero) ‚Äî clip to below zero line
      c.save();
      c.beginPath();
      c.rect(left,zeroY,right-left,bottom-zeroY);
      c.clip();
      c.beginPath();
      c.moveTo(meta.data[0].x,zeroY);
      meta.data.forEach(pt=>c.lineTo(pt.x,pt.y));
      c.lineTo(meta.data[meta.data.length-1].x,zeroY);
      c.closePath();
      const gRed=c.createLinearGradient(0,zeroY,0,bottom);
      gRed.addColorStop(0,'rgba(239,68,68,0.03)');
      gRed.addColorStop(1,'rgba(239,68,68,0.25)');
      c.fillStyle=gRed;c.fill();
      c.restore();
    }
  };

  return new Chart(ctx,{type:'line',
    plugins:[ChartDataLabels,zeroFillPlugin],
    data:{labels:padLabels,datasets:[{
      data:padCum,
      borderColor:lineColor,
      borderWidth:2.5,
      pointRadius:ctx2=>padCum[ctx2.dataIndex]!==null?4:0,
      pointBackgroundColor:ctx2=>{const v=padCum[ctx2.dataIndex];return v===null?'transparent':v>=0?'#22C55E':'#EF4444'},
      pointBorderColor:'#13151F',
      pointBorderWidth:2,
      pointHoverRadius:6,
      pointHoverBackgroundColor:lineColor,
      pointHoverBorderColor:'#13151F',
      pointHoverBorderWidth:2,
      tension:0.3,
      fill:false,
      spanGaps:false,
    }]},
    options:{responsive:true,maintainAspectRatio:true,
      interaction:{intersect:false,mode:'index'},
      plugins:{
        legend:{display:false},
        datalabels:{display:false},
        tooltip:{
          filter:c=>padCum[c.dataIndex]!==null,
          backgroundColor:'#13151F',titleColor:'#E8E9ED',bodyColor:'#8B8D97',
          borderColor:'#3B82F6',borderWidth:1,cornerRadius:10,padding:12,
          displayColors:false,
          callbacks:{
            label:c=>{
              const i=c.dataIndex;
              const d=padDaily[i];
              const total=padCum[i];
              if(total===null)return'';
              return[
                '\u0417\u0430 \u043f\u0435\u0440\u0438\u043e\u0434: '+(d>=0?'+':'')+d.toFixed(2)+' '+currency,
                '\u0418\u0442\u043e\u0433\u043e: '+(total>=0?'+':'')+total.toFixed(2)+' '+currency
              ];
            }
          }
        }
      },
      scales:{
        x:{ticks:{color:'#5A5C66',maxRotation:45,font:{size:11,family:'Inter,sans-serif'}},grid:{display:false}},
        y:{
          min:yMin,max:yMax,
          ticks:{color:'#5A5C66',callback:v=>(v>=0?'+':'')+v.toFixed(0)+' '+sym,font:{size:10,family:'Inter,sans-serif'}},
          grid:{color:c=>c.tick.value===0?'rgba(255,255,255,0.15)':'rgba(255,255,255,0.05)',lineWidth:c=>c.tick.value===0?2:1},
        }
      }
    }
  });
}

function buildCombinedChart(canvasId, allLabels, seriesMap){
  // seriesMap: {SCALP: {labels:[], daily:[]}, DEGEN: {...}, ...}
  const ctx=document.getElementById(canvasId).getContext('2d');

  // Pad x-axis +20% with empty space (same as buildArea)
  const extra=Math.max(1,Math.ceil(allLabels.length*0.2));
  const padLabels=[...allLabels];
  for(let i=0;i<extra;i++){padLabels.push('')}

  const datasets=[];
  const dailyMaps={};  // for datalabels: dailyMaps[datasetIdx][pointIdx]
  let dsIdx=0;
  Object.keys(seriesMap).forEach(name=>{
    const s=seriesMap[name];
    const color=INST_COLORS[name]||'#999';
    // Build cumulative PnL aligned to allLabels
    const cumMap={};const dayMap={};let cum=0;
    for(let i=0;i<s.labels.length;i++){cum+=s.daily[i];cumMap[s.labels[i]]=cum;dayMap[s.labels[i]]=s.daily[i]}
    const data=[];const daily=[];let lastVal=null;
    allLabels.forEach(l=>{
      if(cumMap[l]!==undefined){lastVal=cumMap[l];data.push(lastVal);daily.push(dayMap[l]||0)}
      else{data.push(lastVal);daily.push(0)}
    });
    // Pad with nulls
    for(let i=0;i<extra;i++){data.push(null);daily.push(0)}
    dailyMaps[dsIdx]=daily;
    datasets.push({
      label:name,
      data:data,
      borderColor:color,
      backgroundColor:color,
      borderWidth:2.5,
      pointRadius:c=>data[c.dataIndex]!==null?4:0,
      pointBackgroundColor:color,
      pointBorderColor:'#13151F',
      pointBorderWidth:2,
      pointHoverRadius:6,
      pointHoverBackgroundColor:color,
      pointHoverBorderColor:'#13151F',
      pointHoverBorderWidth:2,
      tension:0.3,
      fill:false,
      spanGaps:true,
    });
    dsIdx++;
  });

  return new Chart(ctx,{type:'line',
    plugins:[ChartDataLabels],
    data:{labels:padLabels,datasets:datasets},
    options:{responsive:true,maintainAspectRatio:true,
      interaction:{intersect:false,mode:'index'},
      plugins:{
        legend:{display:true,position:'top',labels:{
          usePointStyle:true,pointStyle:'circle',padding:16,
          font:{size:12,weight:'600',family:'Inter,sans-serif'},color:'#8B8D97',
        }},
        datalabels:{display:false},
        tooltip:{
          filter:c=>c.parsed.y!==null,
          backgroundColor:'#13151F',titleColor:'#E8E9ED',bodyColor:'#8B8D97',
          borderColor:'#3B82F6',borderWidth:1,cornerRadius:10,padding:12,
          callbacks:{
            label:c=>{
              const v=c.parsed.y;
              if(v===null)return'';
              const cur=INST_CURRENCY[c.dataset.label]||'USDT';
              const d=dailyMaps[c.datasetIndex][c.dataIndex];
              return c.dataset.label+': '+(v>=0?'+':'')+v.toFixed(2)+' '+cur+' ('+(d>=0?'+':'')+d.toFixed(2)+')';
            }
          }
        }
      },
      scales:{
        x:{ticks:{color:'#5A5C66',maxRotation:45,font:{size:10,family:'Inter,sans-serif'},maxTicksLimit:20},grid:{display:false}},
        y:{
          ticks:{color:'#5A5C66',callback:v=>(v>=0?'+':'')+v.toFixed(0),font:{size:10,family:'Inter,sans-serif'}},
          grid:{color:c=>c.tick.value===0?'rgba(255,255,255,0.15)':'rgba(255,255,255,0.05)',lineWidth:c=>c.tick.value===0?2:1},
        }
      }
    }
  });
}

function expandChart(instName){
  const d=instanceData[instName];
  if(!d||!d.labels.length)return;
  if(chartFull){chartFull.destroy();chartFull=null}
  const color=INST_COLORS[instName]||'#818cf8';
  const cur=INST_CURRENCY[instName]||'USDT';
  const sym=INST_SYM[instName]||'$';
  document.getElementById('fullscreen-label').textContent=instName+' ‚Äî –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π PnL ('+cur+')';
  chartFull=buildArea('pnlChartFull',d.labels,d.daily,color,cur,sym);
  document.getElementById('chart-fullscreen').style.display='flex';
}

function closeFullscreen(e){
  if(e&&e.target!==document.getElementById('chart-fullscreen'))return;
  document.getElementById('chart-fullscreen').style.display='none';
  if(chartFull){chartFull.destroy();chartFull=null}
}

async function loadChart(){
  try{
    let pnlUrl='/api/pnl?days=30&tf='+currentTF+'&source='+currentSource;
    if(archiveDate)pnlUrl+='&date='+archiveDate+'&range='+archiveRange;
    const pnl=await(await fetch(pnlUrl)).json();
    // Destroy old charts
    if(chartCombined){chartCombined.destroy();chartCombined=null}
    Object.values(miniCharts).forEach(c=>c.destroy());miniCharts={};
    instanceData={};

    if(!pnl.length){
      const cc=document.getElementById('pnlChartCombined');
      const cx=cc.getContext('2d');cx.clearRect(0,0,cc.width,cc.height);
      cx.fillStyle='#5A5C66';cx.font='14px Inter,sans-serif';cx.textAlign='center';
      cx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥',cc.width/2,cc.height/2);
      // Show all mini-charts with "no data" placeholder
      Object.keys(INST_MINI).forEach(name=>{
        const el=document.getElementById(INST_MINI[name]);
        el.style.display='';
        const c=document.getElementById(INST_CANVAS[name]);
        const cx2=c.getContext('2d');cx2.clearRect(0,0,c.width,c.height);
        cx2.fillStyle='#5A5C66';cx2.font='13px Inter,sans-serif';cx2.textAlign='center';
        cx2.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',c.width/2,c.height/2);
      });
      document.getElementById('chart-legend').innerHTML='';
      return;
    }

    const labels=pnl.map(d=>{
      const dt=d.trade_date;
      if(currentTF==='1M')return dt.slice(0,7);
      if(currentTF==='1D')return dt.slice(5,10);
      return dt.length>16?dt.slice(5,16).replace('T',' '):dt.length>10?dt.slice(11,16):dt;
    });

    // Parse per-instance data from API response
    // API keys: SCALP, DEGEN, SWING, TBANK-SCALP, TBANK-SWING
    const instDaily={};
    const KNOWN_INST=['FIBA','TBANK-SCALP','TBANK-SWING','MIDAS'];

    pnl.forEach((d,i)=>{
      const keys=Object.keys(d).filter(k=>!['trade_date','pnl','trades_count'].includes(k));
      if(keys.length===0){
        // Fallback: no instance keys, assign all pnl to SCALP
        if(!instDaily['SCALP'])instDaily['SCALP']=new Array(pnl.length).fill(0);
        instDaily['SCALP'][i]=d.pnl||0;
        return;
      }
      keys.forEach(k=>{
        const name=k.toUpperCase();
        // Normalize to known instance names
        let mapped=KNOWN_INST.find(n=>name===n||name.replace(/_/g,'-')===n);
        if(!mapped){
          // Fuzzy: TBANK_SCALP -> TBANK-SCALP, etc
          if(name.includes('TBANK')&&name.includes('SCALP'))mapped='TBANK-SCALP';
          else if(name.includes('TBANK')&&name.includes('SWING'))mapped='TBANK-SWING';
          else if(name.includes('MIDAS'))mapped='MIDAS';
          else if(name.includes('FIBA')||name.includes('SMC'))mapped='FIBA';
          else mapped='FIBA';
        }
        if(!instDaily[mapped])instDaily[mapped]=new Array(pnl.length).fill(0);
        instDaily[mapped][i]+=(d[k]||0);
      });
    });

    // Filter: keep only points where instance had a trade
    function filterSeries(lbl,daily){
      const fl=[],fd=[];
      for(let i=0;i<daily.length;i++){if(daily[i]!==0){fl.push(lbl[i]);fd.push(daily[i])}}
      return{labels:fl,daily:fd};
    }

    // Build per-instance data (no filtering ‚Äî show gaps/zeros)
    const seriesMap={};
    const allInstLabels=new Set();
    Object.keys(instDaily).forEach(name=>{
      const hasData=instDaily[name].some(v=>v!==0);
      if(hasData){
        const all={labels:labels,daily:instDaily[name]};
        instanceData[name]=all;
        seriesMap[name]=all;
        labels.forEach(l=>allInstLabels.add(l));
      }
    });

    // Combined chart ‚Äî all instances with data
    const allLabels=[...allInstLabels].sort();
    if(Object.keys(seriesMap).length>0){
      chartCombined=buildCombinedChart('pnlChartCombined',allLabels,seriesMap);
    }else{
      const cc=document.getElementById('pnlChartCombined');
      const cx=cc.getContext('2d');cx.clearRect(0,0,cc.width,cc.height);
      cx.fillStyle='#5A5C66';cx.font='14px Inter,sans-serif';cx.textAlign='center';
      cx.fillText('–ù–µ—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫',cc.width/2,cc.height/2);
    }

    // Mini-charts per instance (always show all)
    KNOWN_INST.forEach(name=>{
      const miniEl=document.getElementById(INST_MINI[name]);
      miniEl.style.display='';
      const d=instanceData[name];
      if(d&&d.daily.length>0){
        const canvasId=INST_CANVAS[name];
        const color=INST_COLORS[name];
        const cur=INST_CURRENCY[name];
        const sym=INST_SYM[name];
        miniCharts[name]=buildArea(canvasId,d.labels,d.daily,color,cur,sym);
      }else{
        const c=document.getElementById(INST_CANVAS[name]);
        const cx=c.getContext('2d');cx.clearRect(0,0,c.width,c.height);
        cx.fillStyle='#5A5C66';cx.font='13px Inter,sans-serif';cx.textAlign='center';
        cx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',c.width/2,c.height/2);
      }
    });

    // Legend (all instances)
    const legHtml=KNOWN_INST.map(name=>
      '<span class="leg-item"><span class="dot" style="background:'+INST_COLORS[name]+'"></span>'+name+'</span>'
    ).join('');
    document.getElementById('chart-legend').innerHTML=legHtml;

  }catch(e){console.error('chart',e)}
}

const ALL_SERVICES=['stasik-smc','stasik-tbank-scalp','stasik-tbank-swing','stasik-midas'];
async function bulkAction(action){
  const label=action==='restart'?'–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å':'–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
  if(!confirm(label+' –í–°–ï–• –±–æ—Ç–æ–≤ ('+ALL_SERVICES.length+')?'))return;
  const btns=document.querySelectorAll('.btn-bulk');
  btns.forEach(b=>{b.disabled=true});
  let ok=0,fail=0;
  for(const svc of ALL_SERVICES){
    try{
      const r=await fetch('/api/toggle-service',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({service:svc,action})});
      const d=await r.json();
      if(d.ok)ok++;else fail++;
    }catch(e){fail++}
  }
  btns.forEach(b=>{b.disabled=false});
  if(fail)alert(label+': '+ok+' –æ–∫, '+fail+' –æ—à–∏–±–æ–∫');
  setTimeout(()=>loadAll(),2000);
}

async function toggleAllLeverage(){
  const btn=document.getElementById('btn-nolev');
  const isOff=btn.dataset.state==='1x';
  const newLev=isOff?0:1;
  const label=isOff?'–í–µ—Ä–Ω—É—Ç—å –ø–ª–µ—á–æ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–æ–≤':'–£–±—Ä–∞—Ç—å –ø–ª–µ—á–æ (1x) –¥–ª—è –í–°–ï–• Bybit –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤';
  if(!confirm(label+'?'))return;
  btn.disabled=true;
  const instances=['SCALP','DEGEN','SWING'];
  let ok=0,fail=0;
  if(isOff){
    for(const inst of instances){
      try{
        const r=await fetch('/api/set-leverage',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({instance:inst,leverage:'config'})});
        const d=await r.json();if(d.ok)ok++;else fail++;
      }catch(e){fail++}
    }
    btn.dataset.state='';btn.textContent='1x No Leverage';
  }else{
    for(const inst of instances){
      try{
        const r=await fetch('/api/set-leverage',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({instance:inst,leverage:1})});
        const d=await r.json();if(d.ok)ok++;else fail++;
      }catch(e){fail++}
    }
    btn.dataset.state='1x';btn.textContent='Restore Leverage';
  }
  btn.disabled=false;
  if(fail)alert(ok+' ok, '+fail+' errors');
  loadInstances();
}

async function toggleService(service,action,btn){
  const label=action==='stop'?'–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å':action==='restart'?'–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å':'–ó–∞–ø—É—Å—Ç–∏—Ç—å';
  if(!confirm(label+' '+service+'?'))return;
  const old=btn.innerHTML;
  btn.disabled=true;btn.innerHTML='&#8987;';
  try{
    const r=await fetch('/api/toggle-service',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({service,action})});
    const d=await r.json();
    if(d.ok){btn.innerHTML='&#10003;';setTimeout(()=>loadAll(),2000)}
    else{alert(d.error||'–û—à–∏–±–∫–∞');btn.disabled=false;btn.innerHTML=old}
  }catch(e){alert('–û—à–∏–±–∫–∞: '+e);btn.disabled=false;btn.innerHTML=old}
}

async function setInstanceLeverage(instance,leverage,sel){
  leverage=parseInt(leverage);
  if(!confirm('Set leverage '+leverage+'x for ALL pairs in '+instance+'?')){
    sel.value=sel.dataset.prev||sel.value;return;
  }
  sel.disabled=true;
  try{
    const r=await fetch('/api/set-leverage',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({instance,leverage})});
    const d=await r.json();
    if(d.ok){sel.dataset.prev=String(leverage);sel.disabled=false;loadInstances()}
    else{alert(d.error||'Error');sel.disabled=false;sel.value=sel.dataset.prev||sel.value}
  }catch(e){alert('Error: '+e);sel.disabled=false;sel.value=sel.dataset.prev||sel.value}
}

async function setPairLeverage(symbol,leverage,sel){
  leverage=parseInt(leverage);
  sel.disabled=true;
  try{
    const r=await fetch('/api/set-leverage',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({symbol,leverage})});
    const d=await r.json();
    if(d.ok){sel.disabled=false}
    else{alert(d.error||'Error');sel.disabled=false;sel.value=sel.dataset.prev||sel.value}
  }catch(e){alert('Error: '+e);sel.disabled=false;sel.value=sel.dataset.prev||sel.value}
}

async function closePosition(symbol,instance,btn){
  if(!confirm('–ó–∞–∫—Ä—ã—Ç—å '+symbol+'?'))return;
  btn.disabled=true;btn.textContent='...';
  try{
    const r=await fetch('/api/close-position',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({symbol,instance})});
    const d=await r.json();
    if(d.ok){btn.innerHTML='&#10003;';loadPositions()}
    else{alert(d.error||'–û—à–∏–±–∫–∞');btn.disabled=false;btn.innerHTML='&times;'}
  }catch(e){alert('–û—à–∏–±–∫–∞: '+e);btn.disabled=false;btn.innerHTML='&times;'}
}
async function doublePosition(symbol,side,qty,instance,btn){
  if(!confirm('–£–¥–≤–æ–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é '+symbol+'? (–¥–æ–±–∞–≤–∏—Ç—å +'+qty+' '+side+')'))return;
  btn.disabled=true;btn.textContent='...';
  try{
    const r=await fetch('/api/double-position',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({symbol,side,qty,instance})});
    const d=await r.json();
    if(d.ok){btn.textContent='OK';setTimeout(()=>loadAll(),1500)}
    else{alert(d.error||'–û—à–∏–±–∫–∞');btn.disabled=false;btn.textContent='X2'}
  }catch(e){alert('–û—à–∏–±–∫–∞: '+e);btn.disabled=false;btn.textContent='X2'}
}
async function closeAllPositions(){
  if(!confirm('Flatten all positions?'))return;
  const btn=document.querySelector('.btn-close-all');
  btn.disabled=true;btn.textContent='Closing...';
  try{
    const r=await fetch('/api/close-all',{method:'POST',headers:{'Content-Type':'application/json'}});
    const d=await r.json();
    if(d.ok){btn.textContent='Done';loadAll()}
    else{alert(d.error||'Error');btn.disabled=false;btn.textContent='CLOSE ALL'}
  }catch(e){alert('–û—à–∏–±–∫–∞: '+e);btn.disabled=false;btn.textContent='–ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏'}
}

let slEditing=false;
async function setSL(symbol,side,entryPrice,qty,instance,btn){
  const input=btn.parentElement.querySelector('.sl-input');
  const amount=parseFloat(input.value);
  if(!amount||amount<=0){alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å—Ç–æ–ø-–ª–æ—Å—Å–∞');return}
  btn.disabled=true;btn.textContent='...';
  try{
    const r=await fetch('/api/set-sl',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({symbol,side,amount,entry_price:entryPrice,qty,instance})});
    const d=await r.json();
    if(d.ok){btn.textContent='OK';input.blur();slEditing=false;setTimeout(()=>loadAll(),1000)}
    else{alert(d.error||'–û—à–∏–±–∫–∞');btn.disabled=false;btn.textContent='OK'}
  }catch(e){alert('–û—à–∏–±–∫–∞: '+e);btn.disabled=false;btn.textContent='OK'}
}
async function setTP(symbol,side,entryPrice,qty,instance,btn){
  const input=btn.parentElement.querySelector('.tp-input');
  const amount=parseFloat(input.value);
  if(!amount||amount<=0){alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞');return}
  btn.disabled=true;btn.textContent='...';
  try{
    const r=await fetch('/api/set-tp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({symbol,side,amount,entry_price:entryPrice,qty,instance})});
    const d=await r.json();
    if(d.ok){btn.textContent='OK';input.blur();slEditing=false;setTimeout(()=>loadAll(),1000)}
    else{alert(d.error||'–û—à–∏–±–∫–∞');btn.disabled=false;btn.textContent='OK'}
  }catch(e){alert('–û—à–∏–±–∫–∞: '+e);btn.disabled=false;btn.textContent='OK'}
}

let _posCache=[];
// _nightCheck removed ‚Äî night mode runs server-side
function _renderPosRow(p){
      const grossPnl=parseFloat(p.unrealised_pnl)||0;
      const inst=(p.instance||'').toUpperCase();
      const isCls=inst.includes('TBANK')?'inst-tbank':inst.includes('DEGEN')?'inst-degen':inst.includes('SCALP')?'inst-scalp':inst.includes('MIDAS')?'inst-midas':inst.includes('TURTLE')?'inst-turtle':inst.includes('FIBA')?'inst-fiba':inst.includes('BUBA')?'inst-buba':'inst-other';
      const iLabel=inst.includes('TBANK-SCALP')?'TB-SCALP':inst.includes('TBANK-SWING')?'TB-SWING':inst.includes('DEGEN')?'DEGEN':inst.includes('SCALP')?'SCALP':inst.includes('MIDAS')?'MIDAS':inst.includes('TURTLE-TB')?'TURTLE-TB':inst.includes('TURTLE')?'TURTLE':inst.includes('FIBA')?'FIBA':inst.includes('BUBA')?'BUBA':inst;
      const closeBtn=currentSource==='live'?`<button class="btn-close-x" onclick="closePosition('${p.symbol}','${p.instance||''}',this)" title="–ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é">&times;</button>`:'';
      const entryAmt=parseFloat(p.entry_amount)||0;
      const feeRate=inst.includes('TBANK')?0.0004:0.00055;
      const fee=Math.round(entryAmt*feeRate*2);
      const pnl=grossPnl-fee;
      const tpPnl=p.tp_pnl!=null?p.tp_pnl:null;
      const tpTxt=tpPnl!=null?fmt(tpPnl):'‚Äî';
      const slPnl=p.sl_pnl!=null?p.sl_pnl:null;
      const slTxt=slPnl!=null?fmt(slPnl):'‚Äî';
      const pc=p.partial_closed||0;
      const soBadge=pc>0?` <span class="so-badge">${pc}/3</span>`:'';
      const key=`${p.instance||''}_${p.symbol}_${p.side}`;
      const lev=p.leverage||'?';
      return`<tr data-pos-key="${key}" class="fade-in">
        <td><span class="inst-tag ${isCls}">${iLabel}</span></td>
        <td style="color:var(--muted)">${p.symbol}${soBadge}</td>
        <td style="color:var(--muted)">${p.side==='Buy'?'<span style="color:#22C55E">\u2191</span> LONG':'<span style="color:#EF4444">\u2193</span> SHORT'}</td>
        <td style="color:var(--accent);font-size:11px">x${lev}</td>
        <td style="color:var(--muted)">${Math.round(entryAmt).toLocaleString()}</td>
        <td style="color:var(--muted)">${tpTxt}</td>
        <td style="color:var(--muted)">${slTxt}</td>
        <td class="${cls(grossPnl)}" data-col="gross">${fmt(grossPnl)}</td>
        <td style="color:var(--amber)">${fee.toLocaleString()}</td>
        <td class="${cls(pnl)}" data-col="net"><strong>${fmt(pnl)}</strong></td>
        <td>${closeBtn}</td></tr>`;
}
async function loadPositions(){
  try{
    if(slEditing)return;
    const pos=await(await fetch('/api/positions?source='+currentSource)).json();
    const body=document.getElementById('pos-body');
    const wrap=document.getElementById('close-all-wrap');
    if(!pos.length){
      body.innerHTML='<tr><td colspan="11" style="text-align:center;color:var(--muted);padding:20px">–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π</td></tr>';
      wrap.style.display='none';_posCache=[];return;
    }
    wrap.style.display=currentSource==='live'?'':'none';
    _posCache=pos;
    body.innerHTML=pos.map(p=>_renderPosRow(p)).join('');
    // night mode runs server-side
  }catch(e){console.error('positions',e)}
}
async function updatePnlOnly(){
  try{
    if(slEditing)return;
    const pos=await(await fetch('/api/positions?source='+currentSource)).json();
    const body=document.getElementById('pos-body');
    if(!pos.length){
      if(_posCache.length>0)loadPositions();
      return;
    }
    if(pos.length!==_posCache.length){loadPositions();return}
    const rows=body.querySelectorAll('tr[data-pos-key]');
    for(const p of pos){
      const key=`${p.instance||''}_${p.symbol}_${p.side}`;
      const row=[...rows].find(r=>r.dataset.posKey===key);
      if(!row){loadPositions();return}
      const grossPnl=parseFloat(p.unrealised_pnl)||0;
      const inst=(p.instance||'').toUpperCase();
      const entryAmt=parseFloat(p.entry_amount)||0;
      const feeRate=inst.includes('TBANK')?0.0004:0.00055;
      const fee=Math.round(entryAmt*feeRate*2);
      const pnl=grossPnl-fee;
      const grossTd=row.querySelector('[data-col="gross"]');
      const netTd=row.querySelector('[data-col="net"]');
      if(grossTd){grossTd.className=cls(grossPnl);grossTd.textContent=fmt(grossPnl)}
      if(netTd){netTd.className=cls(pnl);netTd.innerHTML='<strong>'+fmt(pnl)+'</strong>'}
    }
    _posCache=pos;
    // night mode runs server-side
  }catch(e){console.error('pnl-update',e)}
}

async function loadTrades(page){
  try{
    let tradesUrl='/api/trades?page='+page+'&per_page=20&source='+currentSource;
    if(archiveDate)tradesUrl+='&date='+archiveDate+'&range='+archiveRange;
    const r=await(await fetch(tradesUrl)).json();
    currentPage=r.page;hasNext=r.has_next;
    document.getElementById('prev-btn').disabled=currentPage<=1;
    document.getElementById('next-btn').disabled=!hasNext;
    document.getElementById('page-info').textContent='Page '+currentPage;
    document.getElementById('tbody').innerHTML=r.trades.map(t=>{
      const p=t.pnl||0;
      const inst=(t.instance||'').toUpperCase();
      const isCls=inst.includes('TBANK')?'inst-tbank':inst.includes('DEGEN')?'inst-degen':inst.includes('SCALP')?'inst-scalp':inst.includes('MIDAS')?'inst-midas':inst.includes('TURTLE')?'inst-turtle':inst.includes('FIBA')?'inst-fiba':inst.includes('BUBA')?'inst-buba':'inst-other';
      const iLabel=inst.includes('TBANK-SCALP')?'TB-SCALP':inst.includes('TBANK-SWING')?'TB-SWING':inst.includes('DEGEN')?'DEGEN':inst.includes('SCALP')?'SCALP':inst.includes('MIDAS')?'MIDAS':inst.includes('TURTLE-TB')?'TURTLE-TB':inst.includes('TURTLE')?'TURTLE':inst.includes('FIBA')?'FIBA':inst.includes('BUBA')?'BUBA':inst;
      const tTime=t.closed_at||t.opened_at||'';
      let tFmt='‚Äî';
      if(tTime){const mskD=new Date(tTime.replace(' ','T'));tFmt=String(mskD.getDate()).padStart(2,'0')+'.'+String(mskD.getMonth()+1).padStart(2,'0')+' '+String(mskD.getHours()).padStart(2,'0')+':'+String(mskD.getMinutes()).padStart(2,'0')}
      const tpc=t.partial_closed||0;
      const tSoBadge=tpc>0?` <span class="so-badge">${tpc}/3</span>`:'';
      const feeRate=inst.includes('TBANK')?0.0004:0.00055;
      const entryAmt=(t.entry_price||0)*(t.qty||0);
      const fee=entryAmt*feeRate*2;
      const netPnl=p-fee;
      const qty=t.qty||0;
      const ps=entryAmt;
      const psFmt=ps>=1000?(ps/1000).toFixed(1)+'k':ps.toFixed(0);
      let dur='‚Äî';
      if(t.opened_at&&t.closed_at){
        const ms=new Date(t.closed_at.replace(' ','T'))-new Date(t.opened_at.replace(' ','T'));
        if(ms>0){const s=Math.floor(ms/1000),m=Math.floor(s/60),h=Math.floor(m/60),d=Math.floor(h/24);dur=d>0?d+'d '+h%24+'h':h>0?h+'h '+m%60+'m':m>0?m+'m':s+'s'}
      }else if(t.opened_at&&t.status==='open'){
        const ms=Date.now()-new Date(t.opened_at.replace(' ','T'));
        if(ms>0){const s=Math.floor(ms/1000),m=Math.floor(s/60),h=Math.floor(m/60),d=Math.floor(h/24);dur=d>0?d+'d '+h%24+'h':h>0?h+'h '+m%60+'m':m>0?m+'m':s+'s'}
      }
      const tLev=t.leverage||'?';
      return`<tr class="fade-in">
        <td><span class="inst-tag ${isCls}">${iLabel}</span></td>
        <td style="color:var(--muted)">${t.symbol}${tSoBadge}</td>
        <td style="color:var(--muted)">${t.side==='Buy'?'<span style="color:#22C55E">\u2191</span> LONG':'<span style="color:#EF4444">\u2193</span> SHORT'}</td>
        <td style="color:var(--accent);font-size:11px">x${tLev}</td>
        <td style="color:var(--muted);font-size:12px">${qty}</td>
        <td style="color:var(--muted)">${t.entry_price||'-'}</td><td style="color:var(--muted)">${t.exit_price||'-'}</td>
        <td style="font-size:12px;color:var(--muted)">$${psFmt}</td>
        <td class="${cls(p)}">${p?p.toFixed(2):'-'}</td>
        <td class="${cls(netPnl)}"><strong>${p?netPnl.toFixed(2):'-'}</strong></td>
        <td style="color:var(--muted);font-size:12px">${tFmt}</td>
        <td style="color:var(--muted);font-size:11px;white-space:nowrap">${dur}</td>
        </tr>`;
    }).join('');
  }catch(e){console.error('trades',e)}
}

function changePage(d){loadTrades(currentPage+d)}

async function loadAll(){
  await Promise.all([loadInstances(),loadStats(),loadChart(),loadPositions(),loadTrades(currentPage),loadPairPnl(),loadMarket()]);
  document.getElementById('last-update').textContent=
    '–û–±–Ω–æ–≤–ª–µ–Ω–æ: '+new Date().toLocaleTimeString('ru-RU');
}
function updateMarketBar(){
  const now=new Date();
  const msk=new Date(now.toLocaleString('en-US',{timeZone:'Europe/Moscow'}));
  const h=msk.getHours(),m=msk.getMinutes(),day=msk.getDay();
  const pad=n=>String(n).padStart(2,'0');
  document.getElementById('msk-clock').textContent=pad(h)+':'+pad(m)+':'+pad(msk.getSeconds())+' –ú–°–ö';
  // Bybit always open ‚Äî show UTC time
  document.getElementById('bybit-dot').className='market-dot open';
  const utc=new Date(now.toLocaleString('en-US',{timeZone:'UTC'}));
  document.getElementById('bybit-hours').textContent='UTC '+pad(utc.getHours())+':'+pad(utc.getMinutes());
  // MOEX: Mon-Fri 10:00-18:50 MSK
  const moexDot=document.getElementById('moex-dot');
  const moexSt=document.getElementById('moex-status');
  const moexHr=document.getElementById('moex-hours');
  const t=h*60+m;
  const isWeekday=day>=1&&day<=5;
  const mainOpen=10*60, mainClose=18*60+50;  // 10:00-18:50
  const evenOpen=19*60+5, evenClose=23*60+50; // 19:05-23:50
  if(!isWeekday){
    moexDot.className='market-dot closed';moexSt.className='market-status closed';
    moexSt.textContent='–í—ã—Ö–æ–¥–Ω–æ–π';moexHr.textContent='–ø–Ω-–ø—Ç 10:00-18:50';
  }else if(t>=mainOpen&&t<mainClose){
    moexDot.className='market-dot open';moexSt.className='market-status open';
    moexSt.textContent='–û—Å–Ω–æ–≤–Ω–∞—è';moexHr.textContent='–¥–æ '+pad(18)+':'+pad(50);
  }else if(t>=evenOpen&&t<evenClose){
    moexDot.className='market-dot open';moexSt.className='market-status open';
    moexSt.textContent='–í–µ—á–µ—Ä–Ω—è—è';moexHr.textContent='–¥–æ '+pad(23)+':'+pad(50);
  }else{
    moexDot.className='market-dot closed';moexSt.className='market-status closed';
    if(t<mainOpen){moexSt.textContent='–ó–∞–∫—Ä—ã—Ç–∞';moexHr.textContent='–æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ 10:00'}
    else{moexSt.textContent='–ó–∞–∫—Ä—ã—Ç–∞';moexHr.textContent='–æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ 10:00'}
  }
  // Session clocks: Asia (Tokyo), London, New York
  const tokyo=new Date(now.toLocaleString('en-US',{timeZone:'Asia/Tokyo'}));
  const london=new Date(now.toLocaleString('en-US',{timeZone:'Europe/London'}));
  const ny=new Date(now.toLocaleString('en-US',{timeZone:'America/New_York'}));
  document.getElementById('sess-asia-time').textContent=pad(tokyo.getHours())+':'+pad(tokyo.getMinutes());
  document.getElementById('sess-london-time').textContent=pad(london.getHours())+':'+pad(london.getMinutes());
  document.getElementById('sess-ny-time').textContent=pad(ny.getHours())+':'+pad(ny.getMinutes());
  // Trading windows in MSK
  // Asia: 02:00-11:00 MSK (avoid), London: 10:00-19:00 MSK, NY: 16:00-01:00 MSK
  document.getElementById('sess-asia-msk').textContent='02-11 –ú–°–ö';
  document.getElementById('sess-london-msk').textContent='10-19 –ú–°–ö';
  document.getElementById('sess-ny-msk').textContent='16-01 –ú–°–ö';
  // Highlight active sessions
  const asiaH=tokyo.getHours();
  const londonH=london.getHours();
  const nyH=ny.getHours();
  document.getElementById('sess-asia').className='session-item'+(asiaH>=9&&asiaH<18?' active':'');
  document.getElementById('sess-london').className='session-item'+(londonH>=8&&londonH<16?' active':'');
  document.getElementById('sess-ny').className='session-item'+(nyH>=8&&nyH<17?' active':'');
}
updateMarketBar();setInterval(updateMarketBar,10000);

loadAll();
setInterval(updatePnlOnly,5000);
setInterval(()=>{if(slEditing)return;loadAll()},15000);

// SSE: instant trade updates
let _sseThrottle=0;
function _sseRefresh(full){
  const now=Date.now();
  if(now-_sseThrottle<2000)return;
  _sseThrottle=now;
  if(full){loadAll()}else{loadPositions();loadStats()}
}
function connectSSE(){
  const es=new EventSource('/api/events');
  es.addEventListener('trade_closed',()=>{console.log('SSE: trade closed');_sseRefresh(true)});
  es.addEventListener('trade_opened',()=>{console.log('SSE: trade opened');_sseRefresh(false)});
  es.onerror=()=>{es.close();setTimeout(connectSSE,5000)};
}
connectSSE();
</script>
</body></html>